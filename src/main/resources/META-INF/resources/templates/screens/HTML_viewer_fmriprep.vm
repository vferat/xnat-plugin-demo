<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2//EN">

$page.setTitle("XDAT")
$page.setLinkColor($ui.alink)
$page.setVlinkColor($ui.vlink)

<select id="select_subject">
</select>

<iframe id="report" width="100%" height="1024"></iframe>

<script type="text/javascript">
	window.onload = load_project;
	// Load Project
	function load_project(){
		const project = XNAT.data.context.projectID;
		window.context = {};
		window.context.project = project
		XNAT.xhr.getFormatJSON(`/data/projects/${project}/resources`, get_fmriprep_resource);
	}

	// Check if FMRIPREP resource exist
	function get_fmriprep_resource(resp){
		const result = resp.ResultSet.Result;
		var xnat_abstractresource_id = null;
		var exists = false;
		result.forEach(function (item, index) {
  			if (item.label == "fmriprep_"){
    			exists = true;
 			}
		});
		// Find available subjects
		if (exists){
			XNAT.xhr.getJSON(`/data/projects/${window.context.project}/resources/fmriprep_/files/`, get_subject_reports);
		} else {
			document.getElementById('report').body.outerHTML = `No fmriprep_ Resource found this project.`;
		}
	}

	// Get all available reports
	function get_subject_reports(resp){
		const result = resp.ResultSet.Result;
		var select = document.getElementById("select_subject");
		var reports = []
		result.forEach(function (item, index) {
			if (item.Name.endsWith(".html")){
				reports.push(item);
			}
		});

		var options = $.map(reports, function(item, idx) {
		var opt = $("<option/>").val(item.Name).text(item.Name).data('obj', item);
		return opt;
		});
					
		$.fn.append.apply($("#select_subject"), options)
		.change(function() {
			$("#select_subject option:selected")
			.each(function(){
				var item = $(this).data('obj');
				window.context.item = item;
				XNAT.xhr.getHTML(item.URI, load_subject_report);
			});
		});
	}
</script>

<script type="text/javascript">
	function load_subject_report(resp){
		const parser = new DOMParser();
		const htmlDoc = parser.parseFromString(resp, 'text/html');
		// base_uri
		var item_uri = window.context.item.URI;
		var base_uri = item_uri.substring(0, item_uri.lastIndexOf('/')) + "/";
		// Load Images
		Array.from(htmlDoc.getElementsByClassName("svg-reportlet")).forEach(function (item, index) {
				// if src
				var src = item.getAttribute('src');
				if (src){
					var filepath = src.slice(2);
					var path = base_uri + filepath;
					console.log(path);
					XNAT.xhr.getText(path, (r) => {setSvgData(r, item)});
				}
				// if data
				var data = item.getAttribute('data');
				if (data){
					var filepath = data.slice(2);
					var path = base_uri + filepath;
					console.log(path);
					XNAT.xhr.getText(path, (r) => {setSvgData(r, item)});
				}
 		});
	}

	function render_report(){
		// Render
		var s = document.getElementById('report').contentWindow.document;
		s.open();
		s.write('<!DOCTYPE html>' + window.htmlDoc.documentElement.outerHTML);
		s.close();
	}

	function setSvgData(resp, item){
		item.outerHTML = resp;
		render_report();
	}
</script>


<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2//EN">
$page.setTitle("XDAT")
$page.setLinkColor($ui.alink)
$page.setVlinkColor($ui.vlink)

<script type="text/javascript">
	// Project
	const project = XNAT.data.context.projectID
	XNAT.xhr.getFormatJSON(`/data/projects/${project}/resources`, getFMRIPREP);
	// Check if FMRIPREP resource exist
	function getFMRIPREP(resp){
		const result = resp.ResultSet.Result;
		var exists = false
		result.forEach(function (item, index) {
  			if (item.label == "FMRIPREP"){
    			exists = true  
 			}
		});
		// 
		if (exists){
			XNAT.xhr.getText(`/data/projects/${project}/resources/FMRIPREP/files/sub-s05.html`, loadReport);
		} else {
			document.getElementById('report').body.innerHTML = `No FMRIPREP Resource found for project ${project}.`;
		}
	}

	function loadReport(resp){
		const parser = new DOMParser();
		const htmlDoc = parser.parseFromString(resp, 'text/html');
		// Load Images
		Array.from(htmlDoc.getElementsByClassName("svg-reportlet")).forEach(function (item, index) {
				// if src
				var src = item.getAttribute('src');
				if (src){
					var path = `/data/projects/${project}/resources/FMRIPREP/files/` + src.substring(2);
					path = `/data/projects/${project}/resources/FMRIPREP/files/sub-s05_ses-01_desc-reconall_T1w.svg`;
					XNAT.xhr.getText(path, (r) => {setSvgData(r, item)});
				}
				// if data
				var data = item.getAttribute('data');
				if (data){
					item.data = "";
					var path = `/data/projects/${project}/resources/FMRIPREP/files/` + data.substring(2);
					var path = `/data/projects/${project}/resources/FMRIPREP/files/sub-s05_ses-01_desc-reconall_T1w.svg`;
					XNAT.xhr.getText(path, (r) => {setSvgData(r, item)});
				}
 		});
		// Render
		var s = document.getElementById('report');
		s.contentDocument.body.appendChild(htmlDoc.documentElement);
		}

		function setSvgData(resp, item){
			item.outerHTML = resp;
		}
</script>

<iframe id="report" width="100%" height="1024"></iframe>